<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø´Ø±Ù - Eaqar</title>
  <link rel="icon" href="logo.png" 
  <meta name="color-scheme" content="light only"/>

  <style>
    /* ===== Ù‡ÙˆÙŠØ© Ø§Ù„Ø£Ù„ÙˆØ§Ù† (Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©) ===== */
    :root{
      --brand:#1f8bcb;
      --brand-dark:#144b81;
      --accent:#0fbf9f;
      --surface:#ffffff;
      --surface-2:#f4f7fb;
      --text:#0f172a;
      --muted:#667085;
      --shadow:0 10px 30px rgba(0,0,0,.15);
      --ring: rgba(31,139,203,.25);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:"Tajawal",system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif;
      color:var(--text);
      background:var(--surface-2);
    }

    /* ===== Ø±Ø£Ø³ Ø§Ù„ØµÙØ­Ø© (Brand Bar) ===== */
    .topbar{
      position:sticky; top:0; z-index:10;
      background:
        radial-gradient(900px 500px at 85% -10%, rgba(31,139,203,.25), transparent 60%),
        linear-gradient(180deg, var(--brand-dark), #1f79b4);
      color:#fff;
      border-bottom:1px solid rgba(255,255,255,.2);
      box-shadow:0 8px 18px rgba(0,0,0,.16);
    }
    .topbar-inner{
      max-width:1200px; margin:0 auto;
      display:flex; align-items:center; justify-content:space-between;
      padding:14px 16px;
    }
    .brand{
      display:flex; align-items:center; gap:10px; font-weight:900;
      letter-spacing:.2px;
    }
    .brand img{width:34px;height:34px;border-radius:8px;background:#fff;object-fit:contain}
    .top-actions{display:flex; gap:10px; align-items:center;}

    /* Ø£Ø²Ø±Ø§Ø± Ù…ØªØ·Ø§Ø¨Ù‚Ø© */
    .btn{
      padding:10px 14px; border-radius:999px;
      border:1px solid rgba(255,255,255,.35);
      background:#fff; color:var(--brand-dark); font-weight:800; cursor:pointer;
    }
    .btn--primary{
      background: linear-gradient(135deg, var(--brand), #58b6e3);
      border:none; color:#062a46; box-shadow:0 10px 22px rgba(31,139,203,.3);
    }
    .btn:disabled{opacity:.6; cursor:not-allowed}

    /* ===== ØºÙ„Ø§Ù Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ===== */
    .wrap{ max-width:1200px; margin:22px auto 40px; padding:0 16px; }

    /* Ø¨Ø·Ø§Ù‚Ø§Øª */
    .card{
      background:var(--surface);
      border-radius:18px;
      box-shadow:var(--shadow);
      border:1px solid rgba(20,75,129,.08);
    }

    /* Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¯Ø®ÙˆÙ„ */
    .login{
      max-width:520px; margin:64px auto;
      padding:22px;
    }
    .login h2{margin:0 0 6px; color:var(--brand-dark); text-align:center}
    .login p{margin:0 0 16px; color:var(--muted); text-align:center}
    .field{margin-bottom:12px}
    .control{
      width:100%; padding:12px 14px; border-radius:12px;
      border:1px solid #d4dbe7; background:#f9fbfe; font-size:1rem; outline:none;
      transition:border-color .18s ease, box-shadow .18s ease, background .18s ease;
    }
    .control:focus{border-color:var(--brand); box-shadow:0 0 0 4px var(--ring); background:#fff}
    .error{color:#dc2626; text-align:center; display:none; margin-top:6px}

    /* Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… */
    .dashboard{ padding:18px }
    .grid{ display:grid; gap:16px; grid-template-columns: 1fr; }
    @media(min-width:900px){ .grid{ grid-template-columns: .45fr 1fr; } }

    /* Ø¨Ø·Ø§Ù‚Ø© Ø¥Ø­ØµØ§Ø¡Ø§Øª */
    .stats{
      padding:16px;
      display:grid; gap:12px;
    }
    .stat{
      border:1px dashed rgba(20,75,129,.18);
      border-radius:14px; padding:14px;
      display:flex; align-items:center; gap:12px;
      background:linear-gradient(180deg, rgba(20,75,129,.05), rgba(31,139,203,.06));
      color:#123354; font-weight:800;
    }
    .stat .chip{min-width:36px;height:36px;display:inline-flex;align-items:center;justify-content:center;border-radius:10px;background:#fff;border:1px solid rgba(31,139,203,.25);box-shadow:0 2px 8px rgba(0,0,0,.08)}

    /* Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
    .toolbar{
      padding:12px 16px; display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;
      border-bottom:1px solid rgba(20,75,129,.08);
    }
    .search{
      display:flex; align-items:center; gap:10px;
      background:#f9fbfe; border:1px solid #d4dbe7; border-radius:12px; padding:6px 10px;
      min-width:260px;
    }
    .search input{
      border:none; outline:none; background:transparent; width:180px; font-size:.95rem;
    }

    /* Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ */
    .table-wrap{ overflow:auto; }
    table{ width:100%; border-collapse:collapse; }
    th, td{ padding:12px 12px; border-bottom:1px solid #eef2f7; text-align:right; font-size:.96rem; }
    th{
      position:sticky; top:0; z-index:1; color:#fff;
      background:var(--brand-dark);
    }
    tr:hover td{ background:#f9fbfe; }
    .empty{ padding:26px; text-align:center; color:var(--muted); }

    /* ØªÙˆØ³Øª */
    .toast{
      position:fixed; inset-inline-start:16px; bottom:16px; z-index:50;
      background:#0fddbd; color:#05343a; padding:12px 16px; border-radius:12px; box-shadow:var(--shadow); display:none; font-weight:800;
    }
    .toast.show{ display:block; animation: pop .4s ease both; }
    @keyframes pop{ from{ transform: translateY(8px); opacity:0 } to{ transform:none; opacity:1 } }
  </style>
</head>
<body>

  <!-- Ø±Ø£Ø³ Ù…ØªØ·Ø§Ø¨Ù‚ Ù…Ø¹ Ø§Ù„Ù‡ÙˆÙŠØ© -->
  <header class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <img src="logo.png" alt="Ø´Ø¹Ø§Ø± Eaqar">
        <div>Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Eaqar</div>
      </div>
      <div class="top-actions">
        <button id="btnSignOut" class="btn" style="display:none;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
      </div>
    </div>
  </header>

  <!-- ØµÙ†Ø¯ÙˆÙ‚ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
  <section id="loginSection" class="card login" aria-label="ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù…Ø´Ø±Ù">
    <h2>ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø´Ø±Ù</h2>
    <p>Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø¨Ø±ÙŠØ¯ Ø§Ù„Ù…Ø´Ø±Ù Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</p>
    <div class="field">
      <input id="email" class="control" type="email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" autocomplete="username" required>
    </div>
    <div class="field">
      <input id="password" class="control" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" autocomplete="current-password" required>
    </div>
    <button id="btnLogin" class="btn btn--primary" style="width:100%;">Ø¯Ø®ÙˆÙ„</button>
    <div id="loginError" class="error">ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ØŒ ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.</div>
  </section>

  <!-- Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… -->
  <main id="dashboardSection" class="wrap" style="display:none;">
    <div class="grid">
      <!-- Ø¥Ø­ØµØ§Ø¡Ø§Øª -->
      <aside class="card stats" aria-label="Ø¥Ø­ØµØ§Ø¡Ø§Øª Ø³Ø±ÙŠØ¹Ø©">
        <div class="stat">
          <span class="chip">ğŸ“¨</span>
          <div>
            Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„<br>
            <b id="statTotal">0</b>
          </div>
        </div>
        <div class="stat">
          <span class="chip">ğŸ”</span>
          <div>Ø¨Ø­Ø« ÙÙˆØ±ÙŠ â€“ Ø§ÙƒØªØ¨ Ù„ØªØµÙÙŠØ© Ø§Ù„Ù†ØªØ§Ø¦Ø¬</div>
        </div>
        <div class="stat">
          <span class="chip">â¬‡ï¸</span>
          <div>ØªØµØ¯ÙŠØ± CSV Ø¨Ù†Ù‚Ø±Ø© ÙˆØ§Ø­Ø¯Ø©</div>
        </div>
      </aside>

      <!-- Ø¬Ø¯ÙˆÙ„ -->
      <section class="card">
        <div class="toolbar">
          <div class="search">
            <span>ğŸ”</span>
            <input id="searchInput" type="search" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù…/Ø¨Ø±ÙŠØ¯/Ø¬ÙˆØ§Ù„/Ø±Ø³Ø§Ù„Ø©â€¦">
          </div>
          <div>
            <button id="btnExport" class="btn">ØªØµØ¯ÙŠØ± CSV</button>
          </div>
        </div>
        <div class="table-wrap">
          <table aria-label="Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„">
            <thead>
              <tr>
                <th>Ø§Ù„Ø§Ø³Ù…</th>
                <th>Ø§Ù„Ø¨Ø±ÙŠØ¯</th>
                <th>Ø§Ù„Ø¬ÙˆØ§Ù„</th>
                <th>Ø§Ù„Ø±Ø³Ø§Ù„Ø©</th>
                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
          <div id="emptyState" class="empty" style="display:none;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</div>
        </div>
      </section>
    </div>
  </main>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>

  <!-- Firebase + Ø§Ù„Ù…Ù†Ø·Ù‚ -->
  <script type="module">
    /* ===== Firebase SDKs ===== */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { getFirestore, collection, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    /* ===== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø´Ø±ÙˆØ¹Ùƒ ===== */
    const firebaseConfig = {
      apiKey: "AIzaSyCDjLeMPjw6k5KaoHmD64AoBccr70w1FjY",
      authDomain: "eaqar-contact.firebaseapp.com",
      projectId: "eaqar-contact",
      storageBucket: "eaqar-contact.firebasestorage.app",
      messagingSenderId: "547232219651",
      appId: "1:547232219651:web:89b9d5476da967fe3e8436"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    /* ===== Ø¹Ù†Ø§ØµØ± Ø§Ù„ØµÙØ­Ø© ===== */
    const loginSection   = document.getElementById('loginSection');
    const dashboard      = document.getElementById('dashboardSection');
    const loginBtn       = document.getElementById('btnLogin');
    const signOutBtn     = document.getElementById('btnSignOut');
    const loginError     = document.getElementById('loginError');
    const tbody          = document.getElementById('tbody');
    const emptyState     = document.getElementById('emptyState');
    const statTotal      = document.getElementById('statTotal');
    const searchInput    = document.getElementById('searchInput');
    const exportBtn      = document.getElementById('btnExport');
    const toast          = document.getElementById('toast');

    function showToast(msg){
      toast.textContent = msg; toast.classList.add('show');
      setTimeout(()=> toast.classList.remove('show'), 2500);
    }

    /* ===== Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ===== */
    onAuthStateChanged(auth, (user)=>{
      if(user){
        loginSection.style.display = 'none';
        dashboard.style.display    = 'block';
        signOutBtn.style.display   = 'inline-block';
        attachRealtime();
      }else{
        dashboard.style.display    = 'none';
        signOutBtn.style.display   = 'none';
        loginSection.style.display = 'block';
      }
    });

    /* ===== ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ===== */
    loginBtn.addEventListener('click', async ()=>{
      loginError.style.display = 'none';
      const email = (document.getElementById('email').value || '').trim();
      const pass  = (document.getElementById('password').value || '').trim();
      if(!email || !pass){ loginError.textContent = 'Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±'; loginError.style.display='block'; return; }
      try{
        await signInWithEmailAndPassword(auth, email, pass);
        showToast('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­ âœ…');
      }catch(err){
        loginError.textContent = 'Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©'; loginError.style.display='block';
      }
    });

    /* ===== ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ ===== */
    signOutBtn.addEventListener('click', async ()=>{
      await signOut(auth);
      showToast('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬');
      // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¬Ø¯ÙˆÙ„
      tbody.innerHTML = ''; statTotal.textContent = '0';
    });

    /* ===== Ø¬Ù„Ø¨ ÙÙˆØ±ÙŠ Ù„Ù„Ø±Ø³Ø§Ø¦Ù„ + Ø¨Ø­Ø« Ù…Ø­Ù„ÙŠ ===== */
    let allRows = []; // Ù…Ø®Ø²Ù† Ù„Ù„Ø¹Ø±Ø¶ ÙˆØ§Ù„Ø¨Ø­Ø«
    function attachRealtime(){
      const q = query(collection(db, 'messages'), orderBy('createdAt','desc'));
      onSnapshot(q, (snap)=>{
        allRows = [];
        snap.forEach(doc=>{
          const d = doc.data();
          allRows.push({
            name: d.name || '',
            email: d.email || '',
            phone: d.phone || '',
            message: d.message || '',
            date: d.createdAt?.toDate ? d.createdAt.toDate() : null
          });
        });
        statTotal.textContent = allRows.length.toString();
        renderTable(allRows);
      }, (err)=> {
        console.error(err);
        showToast('ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
      });
    }

    function renderTable(rows){
      const q = (searchInput.value || '').toLowerCase().trim();
      const filtered = !q ? rows : rows.filter(r =>
        (r.name+r.email+r.phone+r.message).toLowerCase().includes(q)
      );

      tbody.innerHTML = '';
      if(filtered.length === 0){ emptyState.style.display='block'; return; }
      emptyState.style.display='none';

      for(const r of filtered){
        const tr = document.createElement('tr');
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… textContent (ØªØ¬Ù†Ù‘Ø¨ Ø¥Ø¯Ø®Ø§Ù„ HTML)
        const d = r.date ? r.date.toLocaleString('ar-SA') : '';
        tr.appendChild(td(r.name));
        tr.appendChild(td(r.email));
        tr.appendChild(td(r.phone));
        tr.appendChild(td(r.message));
        tr.appendChild(td(d));
        tbody.appendChild(tr);
      }
    }

    function td(text){
      const cell = document.createElement('td');
      cell.textContent = text ?? '';
      return cell;
    }

    searchInput.addEventListener('input', ()=> renderTable(allRows));

    /* ===== ØªØµØ¯ÙŠØ± CSV ===== */
    exportBtn.addEventListener('click', ()=>{
      if(allRows.length === 0){ showToast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±'); return; }
      const header = ['Ø§Ù„Ø§Ø³Ù…','Ø§Ù„Ø¨Ø±ÙŠØ¯','Ø§Ù„Ø¬ÙˆØ§Ù„','Ø§Ù„Ø±Ø³Ø§Ù„Ø©','Ø§Ù„ØªØ§Ø±ÙŠØ®'];
      const lines = [header.join(',')];
      for(const r of allRows){
        const row = [
          safeCSV(r.name),
          safeCSV(r.email),
          safeCSV(r.phone),
          safeCSV(r.message),
          safeCSV(r.date ? r.date.toLocaleString('ar-SA') : '')
        ].join(',');
        lines.push(row);
      }
      const blob = new Blob(['\uFEFF'+lines.join('\n')], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'messages.csv';
      a.click();
      URL.revokeObjectURL(a.href);
    });

    function safeCSV(value){
      const v = (value ?? '').toString().replace(/"/g,'""');
      return `"${v}"`;
    }
  </script>
</body>
</html>
