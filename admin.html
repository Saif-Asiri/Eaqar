<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø´Ø±Ù - Eaqar</title>
  <link rel="icon" href="logo.png"/>
  <meta name="color-scheme" content="light only"/>

  <style>
    :root{
      --brand:#1f8bcb; --brand-dark:#144b81; --accent:#0fbf9f;
      --surface:#ffffff; --surface-2:#f4f7fb; --text:#0f172a; --muted:#667085;
      --shadow:0 10px 30px rgba(0,0,0,.15); --ring: rgba(31,139,203,.25);
      --new-indicator:#63b3ed; --danger:#dc2626;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:"Tajawal",system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif;color:var(--text);background:var(--surface-2)}

    /* Topbar */
    .topbar{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,var(--brand-dark),#1f79b4);color:#fff;box-shadow:0 8px 18px rgba(0,0,0,.16)}
    .topbar-inner{max-width:1200px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;padding:14px 16px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:900}
    .brand img{width:34px;height:34px;border-radius:8px;background:#fff;object-fit:contain}
    .top-actions{display:flex;gap:8px;flex-wrap:wrap}
    .btn{padding:8px 14px;border-radius:999px;border:1px solid rgba(20,75,129,.18);background:#fff;color:var(--brand-dark);font-weight:800;cursor:pointer}
    .btn--primary{background:linear-gradient(135deg,var(--brand),#58b6e3);border:none;color:#062a46;box-shadow:0 10px 22px rgba(31,139,203,.3)}
    .btn--ghost{background:#f1f5f9;border-color:#e2e8f0}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .tab-active{outline:3px solid rgba(255,255,255,.35)}

    .wrap{max-width:1200px;margin:22px auto 40px;padding:0 16px}
    .card{background:var(--surface);border-radius:18px;box-shadow:var(--shadow);border:1px solid rgba(20,75,129,.08)}
    .section{display:none}
    .section.show{display:block}

    /* Login */
    .login{max-width:520px;margin:64px auto;padding:22px}
    .login h2{margin:0 0 6px;text-align:center;color:var(--brand-dark)}
    .login p{text-align:center;color:var(--muted);margin:0 0 16px}
    .field{margin-bottom:12px}
    .control{width:100%;padding:12px 14px;border-radius:12px;border:1px solid #d4dbe7;background:#f9fbfe;font-size:1rem}
    .control:focus{border-color:var(--brand);box-shadow:0 0 0 4px var(--ring);background:#fff}
    .error{color:#dc2626;text-align:center;display:none;margin-top:6px}

    /* Grid */
    .grid{display:grid;gap:16px}
    @media(min-width:900px){.grid-2{grid-template-columns:.45fr 1fr}}

    /* Stats */
    .stats{padding:12px;display:grid;gap:10px}
    .stat{border:1px dashed rgba(20,75,129,.18);border-radius:12px;padding:10px;display:flex;align-items:center;gap:10px;background:linear-gradient(180deg,rgba(20,75,129,.04),rgba(31,139,203,.05));color:#123354;font-weight:700;font-size:.9rem}
    .stat .chip{min-width:28px;height:28px;display:inline-flex;align-items:center;justify-content:center;border-radius:8px;background:#fff;border:1px solid rgba(31,139,203,.25);font-size:.9rem}

    /* Toolbar */
    .toolbar{padding:12px 16px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;border-bottom:1px solid rgba(20,75,129,.08)}
    .search{display:flex;align-items:center;gap:10px;background:#f9fbfe;border:1px solid #d4dbe7;border-radius:12px;padding:6px 10px;min-width:260px}
    .search input{border:none;outline:none;background:transparent;width:180px}
    .filter-buttons{display:flex;gap:8px;flex-wrap:wrap}
    .badge{display:none;min-width:18px;padding:2px 6px;border-radius:999px;font-size:.8rem;font-weight:700;background:var(--brand);color:#fff;margin-inline-start:4px}

    /* Table */
    .table-wrap{overflow:auto}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #eef2f7;text-align:right;font-size:.9rem}
    th{position:sticky;top:0;color:#fff;background:var(--brand-dark)}
    tr:hover td{background:#f9fbfe}
    .empty{padding:20px;text-align:center;color:#888}

    .new-indicator{width:10px;height:10px;border-radius:50%;background:var(--new-indicator);display:inline-block;margin-inline-end:6px}
    .delete-btn{background:#e2e8f0;color:#444;border:none;border-radius:6px;padding:4px 8px;font-size:.8rem;cursor:pointer;transition:background .2s,color .2s}
    .delete-btn:hover{background:#dc2626;color:#fff}

    .toast{position:fixed;inset-inline-start:16px;bottom:16px;z-index:50;background:#0fddbd;color:#05343a;padding:12px 16px;border-radius:12px;box-shadow:var(--shadow);display:none;font-weight:800}
    .toast.show{display:block;animation:pop .4s ease both}
    @keyframes pop{from{transform:translateY(8px);opacity:0}to{transform:none;opacity:1}}

    /* ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª */
    .form-grid{display:grid;gap:12px}
    @media(min-width:900px){.form-grid{grid-template-columns:1fr 1fr}}
    .fg{display:flex;flex-direction:column;gap:6px}
    .label{font-weight:800;color:#113354}
    .hint{color:#667085;font-size:.85rem}
    .row-1{grid-column:1/-1}
    .switch{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .switch label{display:flex;align-items:center;gap:8px}

    /* ØµÙˆØ± Ø§Ù„Ø¹Ù‚Ø§Ø± */
    .thumbs{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
    .thumb{
      position:relative;width:76px;height:76px;border-radius:12px;overflow:hidden;
      border:1px solid #e5e9f2;background:#fff;box-shadow:0 1px 3px rgba(0,0,0,.04)
    }
    .thumb img{width:100%;height:100%;object-fit:cover;display:block}
    .thumb .btn-x{
      position:absolute;top:6px;inset-inline-start:6px;width:22px;height:22px;border-radius:999px;
      border:none;background:rgba(0,0,0,.55);color:#fff;cursor:pointer;font-weight:900;line-height:22px;
    }
    .thumb .cover-dot{
      position:absolute;inset-inline-end:6px;bottom:6px;width:22px;height:22px;border-radius:999px;
      background:#fff;border:2px solid #cbd5e1;cursor:pointer;display:flex;align-items:center;justify-content:center;
      font-size:14px;user-select:none
    }
    .thumb.cover .cover-dot{background:#1f8bcb;border-color:#1f8bcb;color:#fff}
    .thumb::after{ /* Ø¥Ø·Ø§Ø± Ù…Ø±Ø¦ÙŠ Ø¹Ù†Ø¯ ÙƒÙˆÙ†Ù‡Ø§ Ø§Ù„ØºÙ„Ø§Ù */
      content:"";position:absolute;inset:0;border:3px solid transparent;border-radius:12px;pointer-events:none
    }
    .thumb.cover::after{border-color:#1f8bcb}

    .actions-row{display:flex;gap:8px;flex-wrap:wrap}
    .danger{background:#fee2e2;color:#991b1b;border:1px solid #fecaca}
    .ghost{background:#f8fafc;border:1px solid #e2e8f0}
    .filters{display:flex;gap:8px;flex-wrap:wrap}
    .chipbtn{padding:6px 10px;border-radius:999px;border:1px solid #dbe3ef;background:#fff;cursor:pointer}
    .chipbtn.active{background:#eaf4ff;border-color:#98c9f5;color:#0f2740;font-weight:800}
    .nowrap{white-space:nowrap}
    .hide{display:none}
  </style>
</head>
<body>
  <header class="topbar">
    <div class="topbar-inner">
      <div class="brand"><img src="logo.png" alt="Ø´Ø¹Ø§Ø± Eaqar"><div>Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Eaqar</div></div>
      <div class="top-actions">
        <!-- Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…Ø­Ù…ÙŠØ© Ø­ØªÙ‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
        <button id="tabMessages" class="btn btn--ghost" style="display:none;">Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</button>
        <button id="tabProps" class="btn btn--ghost" style="display:none;">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª</button>
        <button id="btnSignOut" class="btn" style="display:none;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
      </div>
    </div>
  </header>

  <!-- ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
  <section id="loginSection" class="card login">
    <h2>ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø´Ø±Ù</h2>
    <p>Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø¨Ø±ÙŠØ¯ Ø§Ù„Ù…Ø´Ø±Ù Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</p>
    <div class="field"><input id="email" class="control" type="email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" autocomplete="username"></div>
    <div class="field"><input id="password" class="control" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" autocomplete="current-password"></div>
    <button id="btnLogin" class="btn btn--primary" style="width:100%;">Ø¯Ø®ÙˆÙ„</button>
    <div id="loginError" class="error">ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ØŒ ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.</div>
  </section>

  <!-- Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ -->
  <main id="messagesSection" class="wrap section">
    <div class="grid grid-2">
      <aside class="card stats">
        <div class="stat"><span class="chip">ğŸ“¨</span><div>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„<br><b id="statTotal">0</b></div></div>
        <div class="stat"><span class="chip">ğŸ†•</span><div>Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©<br><b id="statNew">0</b></div></div>
        <div class="stat"><span class="chip">âœ…</span><div>Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡Ø©<br><b id="statRead">0</b></div></div>
      </aside>

      <section class="card">
        <div class="toolbar">
          <div class="search"><span>ğŸ”</span><input id="searchInput" type="search" placeholder="Ø§Ø¨Ø­Ø«â€¦"></div>
          <div class="filter-buttons">
            <button id="btnAll" class="btn btn--primary">Ø§Ù„ÙƒÙ„</button>
            <button id="btnNew" class="btn">Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© <span id="badgeNew" class="badge">0</span></button>
            <button id="btnRead" class="btn">Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡Ø©</button>
            <button id="btnExport" class="btn">ØªØµØ¯ÙŠØ± CSV</button>
          </div>
        </div>
        <div class="table-wrap">
          <table aria-label="Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„">
            <thead><tr><th></th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø¨Ø±ÙŠØ¯</th><th>Ø§Ù„Ø¬ÙˆØ§Ù„</th><th>Ø§Ù„Ø±Ø³Ø§Ù„Ø©</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
            <tbody id="tbody"></tbody>
          </table>
          <div id="emptyState" class="empty" style="display:none;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</div>
        </div>
      </section>
    </div>
  </main>

  <!-- ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª -->
  <main id="propsSection" class="wrap section">
    <div class="grid grid-2">
      <!-- Ù†Ù…ÙˆØ°Ø¬ -->
      <section class="card" style="padding:16px">
        <h3 style="margin:0 0 6px;color:#144b81">Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù‚Ø§Ø±</h3>
        <p class="hint" style="margin:0 0 14px">Ø§Ø®ØªØ± Ø§Ù„ØµÙˆØ± ÙˆØ­Ø¯Ø¯ Ø§Ù„ØºÙ„Ø§Ù Ø¨Ø§Ù„Ù†Ù‚Ø·Ø© Ø§Ù„Ø¯Ø§Ø¦Ø±ÙŠØ©. Ø­Ø°Ù Ø§Ù„ØµÙˆØ±Ø© ÙŠØªÙ… Ø¨Ø²Ø± X.</p>

        <div class="form-grid">
          <div class="fg"><label class="label">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label><input id="p_title" class="control" placeholder="Ù…Ø«Ø§Ù„: ÙÙŠÙ„Ø§ ÙØ§Ø®Ø±Ø© â€“ Ø­ÙŠ Ø§Ù„Ø±Ø¨ÙŠØ¹"></div>
          <div class="fg"><label class="label">Ø§Ù„Ù†ÙˆØ¹</label>
            <select id="p_type" class="control">
              <option value="ÙÙŠÙ„Ø§">ÙÙŠÙ„Ø§</option><option value="Ø´Ù‚Ø©">Ø´Ù‚Ø©</option><option value="Ø£Ø±Ø¶">Ø£Ø±Ø¶</option>
            </select>
          </div>
          <div class="fg"><label class="label">Ø§Ù„Ø³Ø¹Ø± (Ø±ÙŠØ§Ù„)</label><input id="p_price" type="number" class="control" placeholder="2500000"></div>
          <div class="fg"><label class="label">Ø§Ù„Ù…Ø³Ø§Ø­Ø©</label><input id="p_area" class="control" placeholder="480 Ù…Â²"></div>
          <div class="fg row-1"><label class="label">Ø§Ù„Ù…ÙˆÙ‚Ø¹ (ÙˆØµÙ)</label><input id="p_loc" class="control" placeholder="Ø§Ù„Ø±ÙŠØ§Ø¶ - Ø­ÙŠ Ø§Ù„Ø±Ø¨ÙŠØ¹"></div>
          <div class="fg"><label class="label">Latitude</label><input id="p_lat" class="control" inputmode="decimal" placeholder="24.77"></div>
          <div class="fg"><label class="label">Longitude</label><input id="p_lng" class="control" inputmode="decimal" placeholder="46.73"></div>

          <div class="fg" id="grp_floor"><label class="label">Ø§Ù„Ø·Ø§Ø¨Ù‚ (Ù„Ù„Ø´Ù‚Ø©)</label><input id="p_floor" class="control" placeholder="Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø³Ø§Ø¨Ø¹"></div>
          <div class="fg" id="grp_rooms"><label class="label">Ø¹Ø¯Ø¯ Ø§Ù„ØºØ±Ù</label><input id="p_rooms" type="number" class="control" placeholder="5"></div>
          <div class="fg" id="grp_baths"><label class="label">Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ù…Ø§Ù…Ø§Øª</label><input id="p_baths" type="number" class="control" placeholder="6"></div>
          <div class="fg row-1" id="grp_bounds"><label class="label">Ø­Ø¯ÙˆØ¯/Ø£Ø·ÙˆØ§Ù„ (Ù„Ù„Ø£Ø±Ø¶)</label><textarea id="p_bounds" class="control" rows="3" placeholder="Ø´Ù…Ø§Ù„Ù‹Ø§ Ø´Ø§Ø±Ø¹ 20Ù… ..."></textarea></div>

          <div class="fg row-1">
            <label class="label">ØµÙˆØ± Ø§Ù„Ø¹Ù‚Ø§Ø± (ÙŠÙ…ÙƒÙ† Ø§Ø®ØªÙŠØ§Ø± Ø¹Ø¯Ø© ØµÙˆØ±)</label>
            <input id="p_images" type="file" class="control" accept="image/*" multiple>
            <!-- Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…Ø­Ø³Ù‘Ù†Ø© -->
            <div id="p_thumbs" class="thumbs" aria-live="polite"></div>
          </div>

          <div class="row-1 switch">
            <label><input id="p_featured" type="checkbox"> Ù…Ù…ÙŠØ² (ÙŠØ¸Ù‡Ø± ÙÙŠ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©)</label>
            <label><input id="p_active" type="checkbox" checked> Ø¸Ø§Ù‡Ø± ÙÙŠ ØµÙØ­Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª</label>
          </div>

          <div class="row-1 actions-row">
            <button id="btnSave" class="btn btn--primary">Ø­ÙØ¸ Ø§Ù„Ø¹Ù‚Ø§Ø±</button>
            <button id="btnReset" class="btn ghost" type="button">ØªÙØ±ÙŠØº Ø§Ù„Ù†Ù…ÙˆØ°Ø¬</button>
            <button id="btnDeleteProp" class="btn danger" type="button" style="display:none">Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù‚Ø§Ø±</button>
          </div>
        </div>
      </section>

      <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª -->
      <section class="card">
        <div class="toolbar">
          <div class="search"><span>ğŸ”</span><input id="p_search" type="search" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù†ÙˆØ§Ù†/Ù†ÙˆØ¹/Ù…ÙˆÙ‚Ø¹â€¦"></div>
          <div class="filters">
            <button class="chipbtn active" data-type="all">Ø§Ù„ÙƒÙ„</button>
            <button class="chipbtn" data-type="ÙÙŠÙ„Ø§">ÙÙŠÙ„Ø§</button>
            <button class="chipbtn" data-type="Ø´Ù‚Ø©">Ø´Ù‚Ø©</button>
            <button class="chipbtn" data-type="Ø£Ø±Ø¶">Ø£Ø±Ø¶</button>
            <span class="nowrap"><input type="checkbox" id="flt_featured"> ÙÙ‚Ø· Ø§Ù„Ù…Ù…ÙŠØ²Ø©</span>
            <span class="nowrap"><input type="checkbox" id="flt_active" checked> ÙÙ‚Ø· Ø§Ù„Ø¸Ø§Ù‡Ø±Ø©</span>
          </div>
        </div>

        <div class="table-wrap">
          <table aria-label="Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª">
            <thead><tr><th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ø³Ø¹Ø±</th><th>Ù…Ù…ÙŠØ²</th><th>Ø¸Ø§Ù‡Ø±</th><th>ØªØ­ÙƒÙ…</th></tr></thead>
            <tbody id="p_tbody"></tbody>
          </table>
          <div id="p_empty" class="empty" style="display:none;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</div>
        </div>
      </section>
    </div>
  </main>

  <div class="toast" id="toast"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { getFirestore, collection, query, orderBy, onSnapshot, doc, updateDoc, deleteDoc, addDoc, serverTimestamp, getDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";

    // ===== Firebase (Ø¨ÙŠØ¦Ø© Ø¹Ø§Ù…Ø©) =====
    const firebaseConfig={apiKey:"AIzaSyCDjLeMPjw6k5KaoHmD64AoBccr70w1FjY",authDomain:"eaqar-contact.firebaseapp.com",projectId:"eaqar-contact",storageBucket:"eaqar-contact.firebasestorage.app",messagingSenderId:"547232219651",appId:"1:547232219651:web:89b9d5476da967fe3e8436"};
    const app=initializeApp(firebaseConfig); const auth=getAuth(app); const db=getFirestore(app); const storage=getStorage(app);

    // ===== ØªØ¨ÙˆÙŠØ¨ =====
    const tabMessages=document.getElementById('tabMessages'), tabProps=document.getElementById('tabProps');
    const messagesSection=document.getElementById('messagesSection'), propsSection=document.getElementById('propsSection');
    tabMessages.addEventListener('click',()=>{tabMessages.classList.add('tab-active');tabProps.classList.remove('tab-active');messagesSection.classList.add('show');propsSection.classList.remove('show')});
    tabProps.addEventListener('click',()=>{tabProps.classList.add('tab-active');tabMessages.classList.remove('tab-active');propsSection.classList.add('show');messagesSection.classList.remove('show')});

    // ===== Ø¯Ø®ÙˆÙ„/Ø®Ø±ÙˆØ¬ =====
    const loginSection=document.getElementById('loginSection'), loginBtn=document.getElementById('btnLogin');
    const signOutBtn=document.getElementById('btnSignOut'), loginError=document.getElementById('loginError');
    const toast=document.getElementById('toast');
    function showToast(m){toast.textContent=m;toast.classList.add('show');setTimeout(()=>toast.classList.remove('show'),2200)}

    onAuthStateChanged(auth,(u)=>{
      if(u){
        // Ø¥Ø®ÙØ§Ø¡ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¯Ø®ÙˆÙ„ØŒ ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙˆØ§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…Ø­Ù…ÙŠØ©
        loginSection.style.display='none';
        tabMessages.style.display='inline-block';
        tabProps.style.display='inline-block';
        signOutBtn.style.display='inline-block';

        // Ø§ÙØªØ­ ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§ÙØªØ±Ø§Ø¶ÙŠÙ‹Ø§ Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        tabMessages.classList.add('tab-active');
        tabProps.classList.remove('tab-active');
        messagesSection.classList.add('show');
        propsSection.classList.remove('show');

        attachRealtimeMessages();
        attachRealtimeProperties();
      } else {
        // Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬: Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙˆØ§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…Ø­Ù…ÙŠØ© ÙˆØ¥Ø¸Ù‡Ø§Ø± Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¯Ø®ÙˆÙ„
        tabMessages.style.display='none';
        tabProps.style.display='none';
        signOutBtn.style.display='none';
        tabMessages.classList.remove('tab-active');
        tabProps.classList.remove('tab-active');
        messagesSection.classList.remove('show');
        propsSection.classList.remove('show');
        loginSection.style.display='block';
      }
    });

    loginBtn.addEventListener('click',async()=>{
      loginError.style.display='none';
      const email=document.getElementById('email').value.trim();
      const pass=document.getElementById('password').value.trim();
      if(!email||!pass){loginError.textContent='Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±';loginError.style.display='block';return}
      try{await signInWithEmailAndPassword(auth,email,pass);showToast('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ âœ…')}
      catch{loginError.textContent='Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©';loginError.style.display='block'}
    });
    signOutBtn.addEventListener('click',async()=>{await signOut(auth);showToast('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬')});

    // ===== Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ =====
    const tbody=document.getElementById('tbody'), emptyState=document.getElementById('emptyState');
    const statTotal=document.getElementById('statTotal'), statNew=document.getElementById('statNew'), statRead=document.getElementById('statRead');
    const searchInput=document.getElementById('searchInput'), btnAll=document.getElementById('btnAll'), btnNew=document.getElementById('btnNew'), btnRead=document.getElementById('btnRead'), badgeNew=document.getElementById('badgeNew'), exportBtn=document.getElementById('btnExport');
    let allRows=[], currentFilter="all";

    function attachRealtimeMessages(){
      const q=query(collection(db,'messages'),orderBy('createdAt','desc'));
      onSnapshot(q,(snap)=>{
        allRows=[];
        snap.forEach(d=>{
          const v=d.data();
          allRows.push({
            id:d.id,name:v.name||'',email:v.email||'',phone:v.phone||'',message:v.message||'',
            read:v.read===true,date:v.createdAt?.toDate?v.createdAt.toDate():null
          });
        });
        updateMsgStats();renderMsgTable();
      },()=>showToast('ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„'));
    }
    function updateMsgStats(){const t=allRows.length,n=allRows.filter(r=>!r.read).length;statTotal.textContent=t;statNew.textContent=n;statRead.textContent=t-n;badgeNew.style.display=n>0?'inline-block':'none';badgeNew.textContent=n}
    function renderMsgTable(){
      let rows=[...allRows];
      if(currentFilter==="new")rows=rows.filter(r=>!r.read);
      if(currentFilter==="read")rows=rows.filter(r=>r.read);
      const q=(searchInput.value||'').toLowerCase().trim();
      if(q)rows=rows.filter(r=>(r.name+r.email+r.phone+r.message).toLowerCase().includes(q));
      tbody.innerHTML='';
      if(rows.length===0){emptyState.style.display='block';return}
      emptyState.style.display='none';
      for(const r of rows){
        const tr=document.createElement('tr');tr.addEventListener('click',()=>markAsRead(r));
        const ind=document.createElement('td');if(!r.read){const dot=document.createElement('span');dot.className='new-indicator';ind.appendChild(dot)}tr.appendChild(ind);
        tr.appendChild(td(r.name));tr.appendChild(td(r.email));tr.appendChild(td(r.phone));tr.appendChild(td(r.message));
        tr.appendChild(td(r.date? r.date.toLocaleString('ar-SA'):'' ));
        const act=document.createElement('td');const del=document.createElement('button');del.textContent='Ø­Ø°Ù';del.className='delete-btn';
        del.addEventListener('click',(e)=>{e.stopPropagation();deleteMessage(r)});
        act.appendChild(del);tr.appendChild(act);tbody.appendChild(tr);
      }
    }
    function td(t){const c=document.createElement('td');c.textContent=t||'';return c}
    async function markAsRead(r){if(r.read)return;try{await updateDoc(doc(db,'messages',r.id),{read:true});}catch(e){}}
    async function deleteMessage(r){if(!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø©ØŸ"))return;try{await deleteDoc(doc(db,'messages',r.id));showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø©');}catch{showToast('ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø©')}}
    searchInput.addEventListener('input',renderMsgTable);
    btnAll.addEventListener('click',()=>{currentFilter="all";setActive(btnAll);renderMsgTable()});
    btnNew.addEventListener('click',()=>{currentFilter="new";setActive(btnNew);renderMsgTable()});
    btnRead.addEventListener('click',()=>{currentFilter="read";setActive(btnRead);renderMsgTable()});
    function setActive(b){[btnAll,btnNew,btnRead].forEach(x=>x.classList.remove('btn--primary'));b.classList.add('btn--primary')}
    exportBtn.addEventListener('click',()=>{
      let rows=[...allRows];
      if(currentFilter==="new")rows=rows.filter(r=>!r.read);
      if(currentFilter==="read")rows=rows.filter(r=>r.read);
      if(rows.length===0){showToast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±');return}
      const header=['Ø§Ù„Ø§Ø³Ù…','Ø§Ù„Ø¨Ø±ÙŠØ¯','Ø§Ù„Ø¬ÙˆØ§Ù„','Ø§Ù„Ø±Ø³Ø§Ù„Ø©','Ø§Ù„ØªØ§Ø±ÙŠØ®','Ù…Ù‚Ø±ÙˆØ¡'],lines=[header.join(',')];
      for(const r of rows){
        lines.push([csv(r.name),csv(r.email),csv(r.phone),csv(r.message),csv(r.date? r.date.toLocaleString('ar-SA'):''),csv(r.read?'Ù†Ø¹Ù…':'Ù„Ø§')].join(','));
      }
      const blob=new Blob(['\uFEFF'+lines.join('\n')],{type:'text/csv;charset=utf-8;'});
      const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='messages.csv';a.click();URL.revokeObjectURL(a.href)
    });
    function csv(v){return `"${(v??'').toString().replace(/"/g,'""')}"`}

    // ===== Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª + Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…Ø­Ø³Ù‘Ù†Ø© =====
    const p_title=document.getElementById('p_title'), p_type=document.getElementById('p_type'), p_price=document.getElementById('p_price'), p_area=document.getElementById('p_area'), p_loc=document.getElementById('p_loc'), p_lat=document.getElementById('p_lat'), p_lng=document.getElementById('p_lng'), p_floor=document.getElementById('p_floor'), p_rooms=document.getElementById('p_rooms'), p_baths=document.getElementById('p_baths'), p_bounds=document.getElementById('p_bounds'), p_images=document.getElementById('p_images'), p_thumbs=document.getElementById('p_thumbs'), p_featured=document.getElementById('p_featured'), p_active=document.getElementById('p_active'), btnSave=document.getElementById('btnSave'), btnReset=document.getElementById('btnReset'), btnDeleteProp=document.getElementById('btnDeleteProp');
    const grp_floor=document.getElementById('grp_floor'), grp_rooms=document.getElementById('grp_rooms'), grp_baths=document.getElementById('grp_baths'), grp_bounds=document.getElementById('grp_bounds');
    const p_tbody=document.getElementById('p_tbody'), p_empty=document.getElementById('p_empty'), p_search=document.getElementById('p_search'), fltFeatured=document.getElementById('flt_featured'), fltActive=document.getElementById('flt_active'), chipBtns=[...document.querySelectorAll('.chipbtn')];

    let propsAll=[], editId=null, typeFilter='all';

    // Ø­Ø§Ù„Ø© ØµÙˆØ± Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
    let newFiles=[];               // Ù…Ù„ÙØ§Øª Ø¬Ø¯ÙŠØ¯Ø© (File[])
    let existingUrls=[];           // Ø±ÙˆØ§Ø¨Ø· Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„Ø¹Ù‚Ø§Ø± Ø¹Ù†Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
    let removedExisting=new Set(); // Ø±ÙˆØ§Ø¨Ø· Ù‚Ø¯ÙŠÙ…Ø© Ø­ÙØ°ÙØª Ù…Ù† Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
    let coverChoice=null;          // {type:'existing'|'new', value:url|index}

    function refreshTypeGroups(){
      const t=p_type.value;
      if(t==='Ø£Ø±Ø¶'){grp_floor.classList.add('hide');grp_rooms.classList.add('hide');grp_baths.classList.add('hide');grp_bounds.classList.remove('hide')}
      else if(t==='Ø´Ù‚Ø©'){grp_floor.classList.remove('hide');grp_rooms.classList.remove('hide');grp_baths.classList.remove('hide');grp_bounds.classList.add('hide')}
      else{grp_floor.classList.add('hide');grp_rooms.classList.remove('hide');grp_baths.classList.remove('hide');grp_bounds.classList.add('hide')}
    }
    refreshTypeGroups(); p_type.addEventListener('change',refreshTypeGroups);

    // Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ± + Ø£Ø¯ÙˆØ§Øª X Ùˆ Ø¯Ø§Ø¦Ø±Ø© Ø§Ù„ØºÙ„Ø§Ù
    function renderThumbs(){
      p_thumbs.innerHTML='';
      // ØµÙˆØ± Ù…ÙˆØ¬ÙˆØ¯Ø©
      for(const url of existingUrls){
        if(removedExisting.has(url)) continue;
        const el=makeThumb(url, ()=>{removedExisting.add(url); if(coverChoice?.type==='existing' && coverChoice.value===url) coverChoice=null; renderThumbs();}, ()=>{coverChoice={type:'existing', value:url}; renderThumbs();});
        if(coverChoice?.type==='existing' && coverChoice.value===url) el.classList.add('cover');
        p_thumbs.appendChild(el);
      }
      // ØµÙˆØ± Ø¬Ø¯ÙŠØ¯Ø©
      newFiles.forEach((file,idx)=>{
        const objectUrl = URL.createObjectURL(file);
        const el=makeThumb(objectUrl, ()=>{
          newFiles.splice(idx,1);
          if(coverChoice?.type==='new' && coverChoice.value===idx) coverChoice=null;
          renderThumbs();
          URL.revokeObjectURL(objectUrl);
        }, ()=>{
          coverChoice={type:'new', value:idx};
          renderThumbs();
        });
        if(coverChoice?.type==='new' && coverChoice.value===idx) el.classList.add('cover');
        p_thumbs.appendChild(el);
      });
    }

    function makeThumb(src,onDelete,onCover){
      const box=document.createElement('div'); box.className='thumb';
      const img=document.createElement('img'); img.src=src; img.alt='ØµÙˆØ±Ø© Ù„Ù„Ø¹Ù‚Ø§Ø±';
      const x=document.createElement('button'); x.type='button'; x.className='btn-x'; x.setAttribute('aria-label','Ø­Ø°Ù Ø§Ù„ØµÙˆØ±Ø©'); x.textContent='Ã—'; x.addEventListener('click',onDelete);
      const dot=document.createElement('button'); dot.type='button'; dot.className='cover-dot'; dot.setAttribute('aria-label','ØªØ¹ÙŠÙŠÙ† ÙƒØºÙ„Ø§Ù'); dot.textContent='â€¢'; dot.addEventListener('click',onCover);
      box.appendChild(img); box.appendChild(x); box.appendChild(dot);
      return box;
    }

    p_images.addEventListener('change',()=>{
      // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù…ØµÙÙˆÙØ© (Ø¨Ø¯ÙˆÙ† Ø±ÙØ¹ ÙÙˆØ±ÙŠ)
      for(const f of p_images.files){ if(/^image\//.test(f.type)) newFiles.push(f) }
      p_images.value='';
      renderThumbs();
    });

    // Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© ÙˆØ¥Ø±Ø¬Ø§Ø¹ Ø±ÙˆØ§Ø¨Ø·Ù‡Ø§
    async function uploadSelectedImages(propId){
      const urls=[];
      for(const f of newFiles){
        const path=`properties/${propId}/${Date.now()}_${Math.random().toString(36).slice(2)}_${sanitizeName(f.name)}`;
        const r=ref(storage,path);
        await uploadBytes(r,f);
        urls.push(await getDownloadURL(r));
      }
      return urls;
    }
    function sanitizeName(name){return name.replace(/[^a-zA-Z0-9._-]/g,'_')}

    btnSave.addEventListener('click',async()=>{
      const title=(p_title.value||'').trim(); if(!title){showToast('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†'); p_title.focus(); return}
      const data={
        title,
        type:p_type.value,
        price:(p_price.value||'').trim(),
        area:(p_area.value||'').trim(),
        location:(p_loc.value||'').trim(),
        lat:parseFloat(p_lat.value)||null,
        lng:parseFloat(p_lng.value)||null,
        floor:(p_type.value==='Ø´Ù‚Ø©'?(p_floor.value||'').trim():null),
        rooms:(p_type.value!=='Ø£Ø±Ø¶'?(parseInt(p_rooms.value)||null):null),
        baths:(p_type.value!=='Ø£Ø±Ø¶'?(parseInt(p_baths.value)||null):null),
        bounds:(p_type.value==='Ø£Ø±Ø¶'?(p_bounds.value||'').trim():null),
        featured:!!p_featured.checked,
        active:!!p_active.checked,
        createdAt:serverTimestamp()
      };

      try{
        let propId, finalImages=[], coverUrl=null;

        if(editId){
          // 1) Ø¯Ù…Ø¬ Ø§Ù„ØµÙˆØ± Ø§Ù„Ø¨Ø§Ù‚ÙŠØ© Ù…Ù† Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© (Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©)
          const snap=await getDoc(doc(db,'properties',editId));
          const old=(snap.data()?.images)||[];
          finalImages = old.filter(u=>!removedExisting.has(u));
          // 2) Ø­Ø¯Ù‘Ø« Ø§Ù„Ø­Ù‚ÙˆÙ„
          await updateDoc(doc(db,'properties',editId),data);
          // 3) Ø§Ø±ÙØ¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙˆØ£Ø¶ÙÙ‡Ø§
          const more=await uploadSelectedImages(editId);
          finalImages = [...finalImages, ...more];
          // 4) Ø­Ø¯Ù‘Ø¯ Ø§Ù„ØºÙ„Ø§Ù
          coverUrl = resolveCover(finalImages, more);
          finalImages = reorderImagesWithCoverFirst(finalImages, coverUrl);
          // 5) Ø§ÙƒØªØ¨ Ø§Ù„ØµÙˆØ± + Ø§Ù„ØºÙ„Ø§Ù
          await updateDoc(doc(db,'properties',editId),{images:finalImages, coverUrl});
          // 6) Ø§Ø­Ø°Ù Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©
          for(const u of removedExisting){ try{await deleteObject(ref(storage,u))}catch{} }
          showToast('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù‚Ø§Ø±');
          propId = editId;
        }else{
          // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªÙ†Ø¯ Ø£ÙˆÙ„Ù‹Ø§ Ù„ÙŠÙƒÙˆÙ† Ù„Ø¯ÙŠÙ†Ø§ id Ù„Ù„Ù…Ø³Ø§Ø±
          const refDoc=await addDoc(collection(db,'properties'),{...data,images:[]});
          propId = refDoc.id;
          const urls=await uploadSelectedImages(propId);
          coverUrl = resolveCover(urls, urls); // ÙƒÙ„Ù‡Ø§ Ø¬Ø¯ÙŠØ¯Ø© Ù‡Ù†Ø§
          const ordered = reorderImagesWithCoverFirst(urls, coverUrl);
          await updateDoc(refDoc,{images:ordered, coverUrl});
          showToast('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù‚Ø§Ø±');
        }

        resetForm();
      }catch(e){
        console.error(e);
        showToast('ØªØ¹Ø°Ø± Ø§Ù„Ø­ÙØ¸');
      }
    });

    // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ØºÙ„Ø§Ù Ø¨Ø­Ø³Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    function resolveCover(allImages, newAdded){
      if(coverChoice?.type==='existing' && allImages.includes(coverChoice.value)) return coverChoice.value;
      if(coverChoice?.type==='new'){
        const idx = coverChoice.value;
        if(Number.isInteger(idx) && newAdded[idx]) return newAdded[idx];
      }
      // Ø§ÙØªØ±Ø§Ø¶ÙŠÙ‹Ø§: Ø£ÙˆÙ„ ØµÙˆØ±Ø© Ù…ØªØ§Ø­Ø©
      return allImages[0] || null;
    }
    function reorderImagesWithCoverFirst(arr, cover){
      if(!cover) return arr;
      const rest = arr.filter(u=>u!==cover);
      return [cover, ...rest];
    }

    btnReset.addEventListener('click',resetForm);
    function resetForm(){
      editId=null;
      p_title.value=''; p_type.value='ÙÙŠÙ„Ø§'; p_price.value=''; p_area.value=''; p_loc.value='';
      p_lat.value=''; p_lng.value=''; p_floor.value=''; p_rooms.value=''; p_baths.value=''; p_bounds.value='';
      p_featured.checked=false; p_active.checked=true;
      // Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø§Ù„Ø© Ø§Ù„ØµÙˆØ±
      newFiles=[]; existingUrls=[]; removedExisting=new Set(); coverChoice=null; p_images.value='';
      p_thumbs.innerHTML='';
      btnDeleteProp.style.display='none';
      refreshTypeGroups();
    }

    btnDeleteProp.addEventListener('click',async()=>{
      if(!editId) return;
      if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù‚Ø§Ø± (Ø³ÙŠØªÙ… Ø­Ø°Ù ØµÙˆØ±Ù‡)ØŸ')) return;
      try{
        const snap=await getDoc(doc(db,'properties',editId));
        const imgs=(snap.data()?.images)||[];
        for(const u of imgs){ try{await deleteObject(ref(storage,u))}catch{} }
        await deleteDoc(doc(db,'properties',editId));
        showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ù‚Ø§Ø±'); resetForm();
      }catch(e){ console.error(e); showToast('ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ø¹Ù‚Ø§Ø±') }
    });

    function attachRealtimeProperties(){
      const q=query(collection(db,'properties'),orderBy('createdAt','desc'));
      onSnapshot(q,(snap)=>{
        propsAll=[];
        snap.forEach(d=>{
          const v=d.data();
          propsAll.push({
            id:d.id,title:v.title||'',type:v.type||'',price:v.price||'',area:v.area||'',location:v.location||'',
            lat:v.lat||null,lng:v.lng||null,floor:v.floor||null,rooms:v.rooms||null,baths:v.baths||null,bounds:v.bounds||null,
            featured:!!v.featured,active:!!v.active,images:Array.isArray(v.images)?v.images:[],coverUrl:v.coverUrl||null,
            createdAt:v.createdAt?.toDate?v.createdAt.toDate():null
          });
        });
        renderProps()
      },()=>showToast('ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª'))
    }

    function renderProps(){
      const q=(p_search.value||'').toLowerCase().trim();
      let rows=propsAll.filter(r=>{
        if(typeFilter!=='all'&&r.type!==typeFilter) return false;
        if(fltFeatured.checked&&!r.featured) return false;
        if(fltActive.checked&&!r.active) return false;
        return (r.title+r.type+r.location).toLowerCase().includes(q);
      });
      p_tbody.innerHTML='';
      if(rows.length===0){p_empty.style.display='block';return}
      p_empty.style.display='none';
      for(const r of rows){
        const tr=document.createElement('tr');
        tr.appendChild(td(r.title)); tr.appendChild(td(r.type)); tr.appendChild(td(r.price||''));
        tr.appendChild(toggleCell(r,'featured','Ù…Ù…ÙŠØ²')); tr.appendChild(toggleCell(r,'active','Ø¸Ø§Ù‡Ø±'));
        const act=document.createElement('td');
        const e=document.createElement('button'); e.className='btn'; e.textContent='ØªØ¹Ø¯ÙŠÙ„'; e.addEventListener('click',()=>fillForm(r));
        const d=document.createElement('button'); d.className='btn danger'; d.textContent='Ø­Ø°Ù'; d.addEventListener('click',()=>deleteProperty(r));
        act.appendChild(e); act.appendChild(document.createTextNode(' ')); act.appendChild(d);
        tr.appendChild(act); p_tbody.appendChild(tr);
      }
    }
    function toggleCell(r,field,label){
      const td=document.createElement('td'); const cb=document.createElement('input'); cb.type='checkbox'; cb.checked=!!r[field];
      cb.addEventListener('change',async()=>{try{await updateDoc(doc(db,'properties',r.id),{[field]:cb.checked});showToast(cb.checked?`ØªÙ… ØªÙØ¹ÙŠÙ„ ${label}`:`ØªÙ… Ø¥Ù„ØºØ§Ø¡ ${label}`)}catch(e){cb.checked=!cb.checked;showToast('ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«')}});
      td.appendChild(cb); return td;
    }
    function fillForm(r){
      editId=r.id;
      // Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù†Øµ
      p_title.value=r.title; p_type.value=r.type; p_price.value=r.price; p_area.value=r.area; p_loc.value=r.location;
      p_lat.value=r.lat??''; p_lng.value=r.lng??''; p_floor.value=r.floor??''; p_rooms.value=r.rooms??''; p_baths.value=r.baths??''; p_bounds.value=r.bounds??'';
      p_featured.checked=r.featured; p_active.checked=r.active;
      // Ø§Ù„ØµÙˆØ±: Ø§Ø¬Ø¹Ù„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù…Ù† Ø¬Ø¯ÙŠØ¯
      newFiles=[]; existingUrls=[...(Array.isArray(r.images)?r.images:[])]; removedExisting=new Set();
      coverChoice = r.coverUrl ? {type:'existing', value:r.coverUrl} : (existingUrls[0]? {type:'existing', value:existingUrls[0]} : null);
      renderThumbs();
      btnDeleteProp.style.display='inline-block';
      refreshTypeGroups(); propsSection.scrollIntoView({behavior:'smooth'});
    }
    async function deleteProperty(r){
      if(!confirm('Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù‚Ø§Ø± Ù…Ø¹ ØµÙˆØ±Ù‡ØŸ')) return;
      try{
        for(const u of (r.images||[])){ try{await deleteObject(ref(storage,u))}catch{} }
        await deleteDoc(doc(db,'properties',r.id));
        showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ù‚Ø§Ø±'); if(editId===r.id) resetForm();
      }catch(e){ showToast('ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ø¹Ù‚Ø§Ø±') }
    }
    p_search.addEventListener('input',renderProps);
    fltFeatured.addEventListener('change',renderProps);
    fltActive.addEventListener('change',renderProps);
    chipBtns.forEach(b=>b.addEventListener('click',()=>{chipBtns.forEach(x=>x.classList.remove('active'));b.classList.add('active');typeFilter=b.dataset.type;renderProps()}));
  </script>
</body>
</html>
