<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>لوحة المشرف - Eaqar</title>
  <link rel="icon" href="logo.png" 
  <meta name="color-scheme" content="light only"/>

  <style>
    /* ===== هوية الألوان (مطابقة للصفحة الرئيسية) ===== */
    :root{
      --brand:#1f8bcb;
      --brand-dark:#144b81;
      --accent:#0fbf9f;
      --surface:#ffffff;
      --surface-2:#f4f7fb;
      --text:#0f172a;
      --muted:#667085;
      --shadow:0 10px 30px rgba(0,0,0,.15);
      --ring: rgba(31,139,203,.25);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:"Tajawal",system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif;
      color:var(--text);
      background:var(--surface-2);
    }

    /* ===== رأس الصفحة (Brand Bar) ===== */
    .topbar{
      position:sticky; top:0; z-index:10;
      background:
        radial-gradient(900px 500px at 85% -10%, rgba(31,139,203,.25), transparent 60%),
        linear-gradient(180deg, var(--brand-dark), #1f79b4);
      color:#fff;
      border-bottom:1px solid rgba(255,255,255,.2);
      box-shadow:0 8px 18px rgba(0,0,0,.16);
    }
    .topbar-inner{
      max-width:1200px; margin:0 auto;
      display:flex; align-items:center; justify-content:space-between;
      padding:14px 16px;
    }
    .brand{
      display:flex; align-items:center; gap:10px; font-weight:900;
      letter-spacing:.2px;
    }
    .brand img{width:34px;height:34px;border-radius:8px;background:#fff;object-fit:contain}
    .top-actions{display:flex; gap:10px; align-items:center;}

    /* أزرار متطابقة */
    .btn{
      padding:10px 14px; border-radius:999px;
      border:1px solid rgba(255,255,255,.35);
      background:#fff; color:var(--brand-dark); font-weight:800; cursor:pointer;
    }
    .btn--primary{
      background: linear-gradient(135deg, var(--brand), #58b6e3);
      border:none; color:#062a46; box-shadow:0 10px 22px rgba(31,139,203,.3);
    }
    .btn:disabled{opacity:.6; cursor:not-allowed}

    /* ===== غلاف المحتوى ===== */
    .wrap{ max-width:1200px; margin:22px auto 40px; padding:0 16px; }

    /* بطاقات */
    .card{
      background:var(--surface);
      border-radius:18px;
      box-shadow:var(--shadow);
      border:1px solid rgba(20,75,129,.08);
    }

    /* نموذج الدخول */
    .login{
      max-width:520px; margin:64px auto;
      padding:22px;
    }
    .login h2{margin:0 0 6px; color:var(--brand-dark); text-align:center}
    .login p{margin:0 0 16px; color:var(--muted); text-align:center}
    .field{margin-bottom:12px}
    .control{
      width:100%; padding:12px 14px; border-radius:12px;
      border:1px solid #d4dbe7; background:#f9fbfe; font-size:1rem; outline:none;
      transition:border-color .18s ease, box-shadow .18s ease, background .18s ease;
    }
    .control:focus{border-color:var(--brand); box-shadow:0 0 0 4px var(--ring); background:#fff}
    .error{color:#dc2626; text-align:center; display:none; margin-top:6px}

    /* لوحة التحكم */
    .dashboard{ padding:18px }
    .grid{ display:grid; gap:16px; grid-template-columns: 1fr; }
    @media(min-width:900px){ .grid{ grid-template-columns: .45fr 1fr; } }

    /* بطاقة إحصاءات */
    .stats{
      padding:16px;
      display:grid; gap:12px;
    }
    .stat{
      border:1px dashed rgba(20,75,129,.18);
      border-radius:14px; padding:14px;
      display:flex; align-items:center; gap:12px;
      background:linear-gradient(180deg, rgba(20,75,129,.05), rgba(31,139,203,.06));
      color:#123354; font-weight:800;
    }
    .stat .chip{min-width:36px;height:36px;display:inline-flex;align-items:center;justify-content:center;border-radius:10px;background:#fff;border:1px solid rgba(31,139,203,.25);box-shadow:0 2px 8px rgba(0,0,0,.08)}

    /* أدوات الجدول */
    .toolbar{
      padding:12px 16px; display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;
      border-bottom:1px solid rgba(20,75,129,.08);
    }
    .search{
      display:flex; align-items:center; gap:10px;
      background:#f9fbfe; border:1px solid #d4dbe7; border-radius:12px; padding:6px 10px;
      min-width:260px;
    }
    .search input{
      border:none; outline:none; background:transparent; width:180px; font-size:.95rem;
    }

    /* جدول الرسائل */
    .table-wrap{ overflow:auto; }
    table{ width:100%; border-collapse:collapse; }
    th, td{ padding:12px 12px; border-bottom:1px solid #eef2f7; text-align:right; font-size:.96rem; }
    th{
      position:sticky; top:0; z-index:1; color:#fff;
      background:var(--brand-dark);
    }
    tr:hover td{ background:#f9fbfe; }
    .empty{ padding:26px; text-align:center; color:var(--muted); }

    /* توست */
    .toast{
      position:fixed; inset-inline-start:16px; bottom:16px; z-index:50;
      background:#0fddbd; color:#05343a; padding:12px 16px; border-radius:12px; box-shadow:var(--shadow); display:none; font-weight:800;
    }
    .toast.show{ display:block; animation: pop .4s ease both; }
    @keyframes pop{ from{ transform: translateY(8px); opacity:0 } to{ transform:none; opacity:1 } }
  </style>
</head>
<body>

  <!-- رأس متطابق مع الهوية -->
  <header class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <img src="logo.png" alt="شعار Eaqar">
        <div>لوحة إدارة Eaqar</div>
      </div>
      <div class="top-actions">
        <button id="btnSignOut" class="btn" style="display:none;">تسجيل الخروج</button>
      </div>
    </div>
  </header>

  <!-- صندوق تسجيل الدخول -->
  <section id="loginSection" class="card login" aria-label="تسجيل الدخول للمشرف">
    <h2>تسجيل دخول المشرف</h2>
    <p>سجّل الدخول ببريد المشرف للوصول إلى الرسائل</p>
    <div class="field">
      <input id="email" class="control" type="email" placeholder="البريد الإلكتروني" autocomplete="username" required>
    </div>
    <div class="field">
      <input id="password" class="control" type="password" placeholder="كلمة المرور" autocomplete="current-password" required>
    </div>
    <button id="btnLogin" class="btn btn--primary" style="width:100%;">دخول</button>
    <div id="loginError" class="error">فشل تسجيل الدخول، تأكد من البيانات.</div>
  </section>

  <!-- لوحة التحكم -->
  <main id="dashboardSection" class="wrap" style="display:none;">
    <div class="grid">
      <!-- إحصاءات -->
      <aside class="card stats" aria-label="إحصاءات سريعة">
        <div class="stat">
          <span class="chip">📨</span>
          <div>
            إجمالي الرسائل<br>
            <b id="statTotal">0</b>
          </div>
        </div>
        <div class="stat">
          <span class="chip">🔎</span>
          <div>بحث فوري – اكتب لتصفية النتائج</div>
        </div>
        <div class="stat">
          <span class="chip">⬇️</span>
          <div>تصدير CSV بنقرة واحدة</div>
        </div>
      </aside>

      <!-- جدول -->
      <section class="card">
        <div class="toolbar">
          <div class="search">
            <span>🔍</span>
            <input id="searchInput" type="search" placeholder="ابحث باسم/بريد/جوال/رسالة…">
          </div>
          <div>
            <button id="btnExport" class="btn">تصدير CSV</button>
          </div>
        </div>
        <div class="table-wrap">
          <table aria-label="قائمة الرسائل">
            <thead>
              <tr>
                <th>الاسم</th>
                <th>البريد</th>
                <th>الجوال</th>
                <th>الرسالة</th>
                <th>التاريخ</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
          <div id="emptyState" class="empty" style="display:none;">لا توجد بيانات</div>
        </div>
      </section>
    </div>
  </main>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>

  <!-- Firebase + المنطق -->
  <script type="module">
    /* ===== Firebase SDKs ===== */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { getFirestore, collection, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    /* ===== إعدادات مشروعك ===== */
    const firebaseConfig = {
      apiKey: "AIzaSyCDjLeMPjw6k5KaoHmD64AoBccr70w1FjY",
      authDomain: "eaqar-contact.firebaseapp.com",
      projectId: "eaqar-contact",
      storageBucket: "eaqar-contact.firebasestorage.app",
      messagingSenderId: "547232219651",
      appId: "1:547232219651:web:89b9d5476da967fe3e8436"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    /* ===== عناصر الصفحة ===== */
    const loginSection   = document.getElementById('loginSection');
    const dashboard      = document.getElementById('dashboardSection');
    const loginBtn       = document.getElementById('btnLogin');
    const signOutBtn     = document.getElementById('btnSignOut');
    const loginError     = document.getElementById('loginError');
    const tbody          = document.getElementById('tbody');
    const emptyState     = document.getElementById('emptyState');
    const statTotal      = document.getElementById('statTotal');
    const searchInput    = document.getElementById('searchInput');
    const exportBtn      = document.getElementById('btnExport');
    const toast          = document.getElementById('toast');

    function showToast(msg){
      toast.textContent = msg; toast.classList.add('show');
      setTimeout(()=> toast.classList.remove('show'), 2500);
    }

    /* ===== حالة المصادقة ===== */
    onAuthStateChanged(auth, (user)=>{
      if(user){
        loginSection.style.display = 'none';
        dashboard.style.display    = 'block';
        signOutBtn.style.display   = 'inline-block';
        attachRealtime();
      }else{
        dashboard.style.display    = 'none';
        signOutBtn.style.display   = 'none';
        loginSection.style.display = 'block';
      }
    });

    /* ===== تسجيل الدخول ===== */
    loginBtn.addEventListener('click', async ()=>{
      loginError.style.display = 'none';
      const email = (document.getElementById('email').value || '').trim();
      const pass  = (document.getElementById('password').value || '').trim();
      if(!email || !pass){ loginError.textContent = 'أدخل البريد وكلمة المرور'; loginError.style.display='block'; return; }
      try{
        await signInWithEmailAndPassword(auth, email, pass);
        showToast('تم تسجيل الدخول بنجاح ✅');
      }catch(err){
        loginError.textContent = 'بيانات الدخول غير صحيحة'; loginError.style.display='block';
      }
    });

    /* ===== تسجيل الخروج ===== */
    signOutBtn.addEventListener('click', async ()=>{
      await signOut(auth);
      showToast('تم تسجيل الخروج');
      // تنظيف الجدول
      tbody.innerHTML = ''; statTotal.textContent = '0';
    });

    /* ===== جلب فوري للرسائل + بحث محلي ===== */
    let allRows = []; // مخزن للعرض والبحث
    function attachRealtime(){
      const q = query(collection(db, 'messages'), orderBy('createdAt','desc'));
      onSnapshot(q, (snap)=>{
        allRows = [];
        snap.forEach(doc=>{
          const d = doc.data();
          allRows.push({
            name: d.name || '',
            email: d.email || '',
            phone: d.phone || '',
            message: d.message || '',
            date: d.createdAt?.toDate ? d.createdAt.toDate() : null
          });
        });
        statTotal.textContent = allRows.length.toString();
        renderTable(allRows);
      }, (err)=> {
        console.error(err);
        showToast('تعذر تحميل البيانات');
      });
    }

    function renderTable(rows){
      const q = (searchInput.value || '').toLowerCase().trim();
      const filtered = !q ? rows : rows.filter(r =>
        (r.name+r.email+r.phone+r.message).toLowerCase().includes(q)
      );

      tbody.innerHTML = '';
      if(filtered.length === 0){ emptyState.style.display='block'; return; }
      emptyState.style.display='none';

      for(const r of filtered){
        const tr = document.createElement('tr');
        // استخدام textContent (تجنّب إدخال HTML)
        const d = r.date ? r.date.toLocaleString('ar-SA') : '';
        tr.appendChild(td(r.name));
        tr.appendChild(td(r.email));
        tr.appendChild(td(r.phone));
        tr.appendChild(td(r.message));
        tr.appendChild(td(d));
        tbody.appendChild(tr);
      }
    }

    function td(text){
      const cell = document.createElement('td');
      cell.textContent = text ?? '';
      return cell;
    }

    searchInput.addEventListener('input', ()=> renderTable(allRows));

    /* ===== تصدير CSV ===== */
    exportBtn.addEventListener('click', ()=>{
      if(allRows.length === 0){ showToast('لا توجد بيانات للتصدير'); return; }
      const header = ['الاسم','البريد','الجوال','الرسالة','التاريخ'];
      const lines = [header.join(',')];
      for(const r of allRows){
        const row = [
          safeCSV(r.name),
          safeCSV(r.email),
          safeCSV(r.phone),
          safeCSV(r.message),
          safeCSV(r.date ? r.date.toLocaleString('ar-SA') : '')
        ].join(',');
        lines.push(row);
      }
      const blob = new Blob(['\uFEFF'+lines.join('\n')], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'messages.csv';
      a.click();
      URL.revokeObjectURL(a.href);
    });

    function safeCSV(value){
      const v = (value ?? '').toString().replace(/"/g,'""');
      return `"${v}"`;
    }
  </script>
</body>
</html>
